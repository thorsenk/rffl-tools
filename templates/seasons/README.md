# Completed Season Template

This template defines the standard structure for a completed RFFL fantasy football season.

## ESPN Data Retention Policy

**Important**: ESPN maintains detailed boxscore data (with projected PF, actual PF, starters, and bench players) for only **6 years** (5 past seasons + current season). This creates two distinct season types:

### Recent Seasons (2019+)
- **Detailed boxscores available**: Full player-level data with projected/actual PF
- **Available files**: `boxscores.csv`, `draft.csv`, `boxscores_normalized.csv`, `teamweek_unified.csv`
- **Transactions available**: `transactions.csv` (may require authentication)
- **Stat corrections available**: `stat_corrections.csv` (requires authentication, for audit/AI reporting)
- **Current window (2025 season)**: 2019-2025 available
- **Next season (2026)**: 2020-2026 available (2019 will be purged)

### Historical Seasons (2011-2018)
- **Detailed boxscores NOT available**: ESPN has purged this data
- **Available files**: `draft.csv`, `h2h.csv` (matchup results only)
- **Transactions**: Endpoint accessible but returns no transaction data (ESPN has purged historical transaction records)
- **Missing files**: `boxscores.csv`, `boxscores_normalized.csv`, `teamweek_unified.csv`, `transactions.csv`

**Preservation Strategy**: Extract and save detailed boxscores for the oldest available year each season before ESPN purges it. For example, in 2025, ensure 2019 data is locked and saved before the 2026 season begins.

**Transaction Data Note**: Unlike boxscores, transaction data availability varies:
- **Recent seasons (2019-2025)**: ✅ Transaction data is available with authentication. Transactions must be fetched per-week using `scoringPeriodId` parameter (the API returns transactions when you specify a specific week). The extraction process iterates through all weeks to collect complete transaction history.
- **Historical seasons (2011-2018)**: Transaction endpoints exist but return no transaction data (ESPN has purged or restricted access to historical transaction records)
- **Key Difference**: Transactions do NOT follow the same strict 6-year retention window as boxscores:
  - 2011-2018: Endpoint accessible but returns empty/no transaction data
  - 2019-2025: ✅ Full transaction data available (requires per-week fetching with `scoringPeriodId`)

## Directory Structure

### Recent Seasons (2019+)
```
data/seasons/{YEAR}/
├── boxscores.csv                    # Main boxscore export (all weeks)
├── draft.csv                        # Draft data (snake draft picks)
├── transactions.csv                 # Transaction history (optional, may require auth)
├── stat_corrections.csv            # Stat corrections history (optional, requires auth)
└── reports/
    ├── {YEAR}-Draft-Snake-Canonicals.csv    # Normalized draft data
    ├── boxscores_normalized.csv             # Normalized boxscore data
    └── teamweek_unified.csv                 # Team-week aggregated data
```

### Historical Seasons (2011-2018)
```
data/seasons/{YEAR}/
├── draft.csv                        # Draft data (snake draft picks)
├── h2h.csv                          # Head-to-head matchup results
└── reports/
    ├── {YEAR}-Draft-Snake-Canonicals.csv    # Normalized draft data
    └── h2h_teamweek.csv                     # Team-week aggregated matchup data

Note: transactions.csv is typically NOT available for these seasons (ESPN has purged or restricted access)
```

## File Descriptions

### `boxscores.csv` (2019+ only)
**Purpose**: Primary boxscore export containing all weekly lineup data with detailed player information.

**Availability**: Only available for seasons 2019 and later (ESPN purges older data).

**Columns**:
- `season_year` - Season year (e.g., 2024)
- `week` - Week number (1-18)
- `matchup` - Matchup number within the week
- `team_code` - Team abbreviation
- `is_co_owned?` - Whether team is co-owned (Yes/No)
- `team_owner_1` - Primary owner name
- `team_owner_2` - Secondary owner name (if co-owned)
- `team_projected_total` - Team's projected points for the week
- `team_actual_total` - Team's actual points for the week
- `slot_type` - Slot type (starters/bench)
- `slot` - Position slot (QB, RB, WR, TE, FLEX, K, D/ST)
- `player_name` - Player name
- `nfl_team` - NFL team abbreviation
- `position` - Player position
- `is_placeholder` - Whether this is a placeholder slot (Yes/No)
- `issue_flag` - Any data quality flags
- `rs_projected_pf` - Projected fantasy points
- `rs_actual_pf` - Actual fantasy points

**Generated by**: `rffl core export` command or `weekly-enhanced-boxscores.yaml` recipe

**Note**: This file is NOT available for seasons 2011-2018 (ESPN has purged this data).

---

### `h2h.csv` (2011-2018 only)
**Purpose**: Head-to-head matchup results with team scores (no player-level detail).

**Availability**: Available for all seasons, but this is the primary data source for 2011-2018.

**Columns**:
- `week` - Week number
- `matchup` - Matchup number within the week
- `home_team` - Home team abbreviation
- `away_team` - Away team abbreviation
- `home_score` - Home team's total points
- `away_score` - Away team's total points
- `winner` - Winning team abbreviation
- `margin` - Point margin

**Generated by**: `rffl core h2h` command or `legacy-h2h.yaml` recipe

---

### `transactions.csv` (2019+ only, optional)
**Purpose**: Transaction history including trades, waivers, free agent pickups, and drops.

**Availability**: Available for seasons 2019-2025 with authentication (ESPN_S2 and SWID cookies required).

**Columns**:
- `season_year` - Season year
- `bid_amount` - Bid amount (for waiver claims)
- `date` - Transaction date
- `effective_date` - Effective date (when applicable)
- `id` - Transaction ID
- `is_pending` - Whether transaction is pending
- `rating` - Transaction rating (if available)
- `status` - Transaction status
- `type` - Transaction type (TRADE, WAIVER, FREE_AGENT, etc.)
- `team_id` - Team ID involved
- `team_code` - Team abbreviation
- `member_id` - Member ID
- `player_id` - Player ID (if applicable)
- `player_name` - Player name (if applicable)
- `to_team_id` - Destination team ID (for trades)
- `to_team_code` - Destination team abbreviation
- `from_team_id` - Source team ID (for trades)
- `from_team_code` - Source team abbreviation

**Generated by**: `rffl core transactions` command or `fill_completed_season.py` script

**Note**: 
- Requires authentication (ESPN_S2 and SWID environment variables)
- Transactions are fetched per-week using `scoringPeriodId` parameter
- Not available for historical seasons (2011-2018) - ESPN has purged this data

---

### `stat_corrections.csv` (2019+ only, optional)
**Purpose**: Historical record of stat corrections made by ESPN for audit and AI reporting purposes.

**Availability**: Available for seasons 2019-2025 with authentication (ESPN_S2 and SWID cookies required).

**Columns**:
- `season_year` - Season year
- `week` - Week number (scoringPeriodId)
- `player_id` - Player ID (if available)
- `player_name` - Player name
- `team_id` - Team ID (if available)
- `team_code` - Team abbreviation (if available)
- `stat_id` - Stat ID that was corrected (if available)
- `stat_name` - Stat name that was corrected
- `original_value` - Original stat value
- `corrected_value` - Corrected stat value
- `points_impact` - Fantasy points impact of correction
- `correction_date` - Date correction was made (if available)

**Generated by**: `rffl core stat-corrections` command or `fill_completed_season.py` script

**Note**: 
- Requires authentication (ESPN_S2 and SWID environment variables)
- Extracted via web scraping from ESPN's stat corrections page
- **Important**: Stat corrections are already baked into boxscore scores (`rs_actual_pf`). This file is for audit/historical tracking purposes only.
- Not available for historical seasons (2011-2018)

---

### `draft.csv`
**Purpose**: Raw draft data from ESPN API.

**Columns**:
- `year` - Season year
- `round` - Draft round number
- `round_pick` - Pick number within round
- `team_abbrev` - Team abbreviation
- `player_id` - ESPN player ID
- `player_name` - Player name
- `bid_amount` - Bid amount (for auction drafts, 0.0 for snake)
- `keeper` - Whether player was kept (True/False)
- `nominating_team` - Team that nominated (for auction drafts)

**Generated by**: `rffl draft` command or `draft.yaml` recipe

---

### `reports/{YEAR}-Draft-Snake-Canonicals.csv`
**Purpose**: Normalized draft data with canonical team names.

**Columns**: Similar to `draft.csv` but with normalized team codes and canonical naming.

**Generated by**: Post-processing scripts or recipes

---

### `reports/boxscores_normalized.csv` (2019+ only)
**Purpose**: Normalized version of boxscores.csv with consistent formatting and data cleaning.

**Availability**: Only available for seasons 2019 and later.

**Columns**: Same as `boxscores.csv` but with:
- Normalized team codes
- Consistent player name formatting
- Data quality improvements

**Generated by**: Post-processing scripts or recipes

**Note**: This file is NOT available for seasons 2011-2018 (ESPN has purged the source data).

---

### `reports/teamweek_unified.csv` (2019+ only)
**Purpose**: Aggregated team-week level data for analysis.

**Availability**: Only available for seasons 2019 and later.

**Columns**:
- `season_year` - Season year
- `week` - Week number
- `matchup` - Matchup number
- `team_code` - Team abbreviation
- `is_co_owned?` - Whether team is co-owned
- `team_owner_1` - Primary owner
- `team_owner_2` - Secondary owner (if co-owned)
- `opponent_code` - Opponent team abbreviation
- `opp_is_co_owned?` - Whether opponent is co-owned
- `opp_owner_1` - Opponent primary owner
- `opp_owner_2` - Opponent secondary owner (if co-owned)
- `team_projected_total` - Team projected points
- `team_actual_total` - Team actual points
- `opp_actual_total` - Opponent actual points
- `result` - Game result (W/L/T)
- `margin` - Point margin (positive = win, negative = loss)

**Generated by**: Post-processing scripts or recipes

**Note**: This file is NOT available for seasons 2011-2018 (ESPN has purged the source data).

---

### `reports/h2h_teamweek.csv` (2011-2018 only)
**Purpose**: Team-week aggregated matchup data derived from h2h.csv.

**Availability**: Available for historical seasons 2011-2018.

**Generated by**: Post-processing scripts or recipes

## Usage

### Creating a New Season Folder

Use the scaffold script:

```bash
python scripts/scaffold_season.py 2025
```

Or manually create the structure:

```bash
mkdir -p data/seasons/2025/reports
touch data/seasons/2025/boxscores.csv
touch data/seasons/2025/draft.csv
touch data/seasons/2025/reports/2025-Draft-Snake-Canonicals.csv
touch data/seasons/2025/reports/boxscores_normalized.csv
touch data/seasons/2025/reports/teamweek_unified.csv
```

### Generating Data

#### Option 1: Automated Script (Recommended)

Use the `fill_completed_season.py` script to export both boxscores and draft data:

```bash
# Fill out a complete season (uses $LEAGUE env var)
python scripts/fill_completed_season.py 2024

# Fill out with specific league ID
python scripts/fill_completed_season.py 2023 --league 323196

# Fill out specific week range
python scripts/fill_completed_season.py 2022 --start-week 1 --end-week 17
```

#### Option 2: Manual Commands

1. **Export boxscores**: 
   ```bash
   rffl core export --year 2024 --fill-missing-slots --require-clean
   ```
   Or use the `weekly-enhanced-boxscores.yaml` recipe:
   ```bash
   rffl recipe run recipes/baselines/weekly-enhanced-boxscores.yaml
   ```

2. **Export draft**: 
   ```bash
   rffl core draft --year 2024
   ```
   Or use the `draft.yaml` recipe:
   ```bash
   rffl recipe run recipes/baselines/draft.yaml
   ```

3. **Export transactions** (optional, 2019+ only, requires authentication):
   ```bash
   # Set credentials in environment or .env file
   export ESPN_S2="your_espn_s2_cookie"
   export SWID="your_swid_cookie"
   
   # Then export transactions
   rffl core transactions --year 2024
   ```
   **Note**: 
   - Transactions require ESPN authentication credentials (`ESPN_S2` and `SWID` cookies)
   - Extract these from your browser cookies when logged into ESPN Fantasy Football
   - See `.env.example` for detailed instructions
   - Transactions are typically not available for seasons before 2019

4. **Generate reports**: Run post-processing recipes or scripts (boxscores_normalized.csv, teamweek_unified.csv)

## Validation

### Recent Seasons (2019+)
A completed recent season should have:
- ✅ `boxscores.csv` with data for all weeks (typically weeks 1-18)
- ✅ `draft.csv` with all draft picks
- ✅ `transactions.csv` (optional, may require authentication)
- ✅ `stat_corrections.csv` (optional, requires authentication)
- ✅ All three report files in `reports/` directory:
  - `{YEAR}-Draft-Snake-Canonicals.csv`
  - `boxscores_normalized.csv`
  - `teamweek_unified.csv`
- ✅ Consistent team codes across all files
- ✅ No missing weeks in boxscores (unless season was shortened)

### Historical Seasons (2011-2018)
A completed historical season should have:
- ✅ `draft.csv` with all draft picks
- ✅ `h2h.csv` with matchup results for all weeks
- ✅ Report files in `reports/` directory:
  - `{YEAR}-Draft-Snake-Canonicals.csv`
  - `h2h_teamweek.csv` (optional)
- ✅ Consistent team codes across all files
- ⚠️ **Note**: `boxscores.csv` and `boxscores_normalized.csv` are NOT available (ESPN has purged this data)

## Examples

See completed seasons:
- `data/seasons/2024/` - Most recent completed season (full boxscore data)
- `data/seasons/2023/` - Previous season (full boxscore data)
- `data/seasons/2019-2022/` - Recent seasons with full boxscore data
- `data/seasons/2011/` - Historical season (draft + h2h only, no detailed boxscores)

## Data Preservation Reminder

**Critical**: ESPN purges detailed boxscore data each season. Always extract and save the oldest available year before the new season begins:

- **2025 season**: Ensure 2019 data is locked and saved (will be purged in 2026)
- **2026 season**: Ensure 2020 data is locked and saved (will be purged in 2027)
- **2027 season**: Ensure 2021 data is locked and saved (will be purged in 2028)
- And so on...

The rolling window always maintains 6 years of detailed data (5 past + current season).

